engine:
  name: terraform
  version: 1.5.7

workflows:
  - tag_query: ''
    plan:
      - type: env
        name: AWS_ACCESS_KEY_ID
        cmd: ['echo', '$PROD_ACCESS_KEY_ID']
      - type: env
        name: AWS_SECRET_ACCESS_KEY
        cmd: ['echo', '$PROD_SECRET_ACCESS_KEY']
      - type: init
      - type: plan
      - type: conftest
        extra_args: ['-o', 'json']
        gate:
          token: create-instance
          any_of: ['team:sre']
          any_of_count: 1
    apply:
      - type: env
        name: AWS_ACCESS_KEY_ID
        cmd: ['echo', '$PROD_ACCESS_KEY_ID']
      - type: env
        name: AWS_SECRET_ACCESS_KEY
        cmd: ['echo', '$PROD_SECRET_ACCESS_KEY']
      - type: init
      - type: apply

automerge:
  enabled: true
  delete_branch: true

